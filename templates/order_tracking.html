{% extends "base.html" %}

{% block title %}Order Tracking - {{ order.order_number }} - SpinMate{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Order Header -->
    <div class="dashboard-header fade-in">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">Order {{ order.order_number }}</h1>
                <p class="mb-0">Placed on {{ order.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
            </div>
            <div class="col-md-4 text-end">
                <span class="badge bg-{{ 'success' if order.status == 'delivered' else 'warning' if order.status == 'pending' else 'info' }}" style="font-size: 1.1rem; padding: 0.8rem 1.5rem;">
                    {{ order.status.title() }}
                </span>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Order Progress -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-route me-2"></i>Order Progress
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 12px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ get_status_progress(order.status) }}%"
                             aria-valuenow="{{ get_status_progress(order.status) }}" 
                             aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                    
                    <!-- Status Steps -->
                    <div class="row text-center">
                        <div class="col">
                            <div class="step {{ 'active' if order.status in ['pending', 'picked', 'washing', 'ready', 'delivered'] else '' }}">
                                <div class="step-icon mb-2">
                                    <i class="fas fa-clock {{ 'text-primary' if order.status == 'pending' else 'text-success' if order.status in ['picked', 'washing', 'ready', 'delivered'] else 'text-muted' }}"></i>
                                </div>
                                <small class="fw-bold">Order Placed</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="step {{ 'active' if order.status in ['picked', 'washing', 'ready', 'delivered'] else '' }}">
                                <div class="step-icon mb-2">
                                    <i class="fas fa-truck {{ 'text-primary' if order.status == 'picked' else 'text-success' if order.status in ['washing', 'ready', 'delivered'] else 'text-muted' }}"></i>
                                </div>
                                <small class="fw-bold">Picked Up</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="step {{ 'active' if order.status in ['washing', 'ready', 'delivered'] else '' }}">
                                <div class="step-icon mb-2">
                                    <i class="fas fa-tint {{ 'text-primary' if order.status == 'washing' else 'text-success' if order.status in ['ready', 'delivered'] else 'text-muted' }}"></i>
                                </div>
                                <small class="fw-bold">Washing</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="step {{ 'active' if order.status in ['ready', 'delivered'] else '' }}">
                                <div class="step-icon mb-2">
                                    <i class="fas fa-check-circle {{ 'text-primary' if order.status == 'ready' else 'text-success' if order.status == 'delivered' else 'text-muted' }}"></i>
                                </div>
                                <small class="fw-bold">Ready</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="step {{ 'active' if order.status == 'delivered' else '' }}">
                                <div class="step-icon mb-2">
                                    <i class="fas fa-home {{ 'text-success' if order.status == 'delivered' else 'text-muted' }}"></i>
                                </div>
                                <small class="fw-bold">Delivered</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Updates -->
            {% if status_updates %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Status Updates
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for update in status_updates %}
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <i class="fas fa-circle" style="font-size: 8px;"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">{{ update.status.title() }}</h6>
                                        <p class="text-muted mb-1">{{ update.timestamp.strftime('%B %d, %Y at %I:%M %p') }}</p>
                                        {% if update.notes %}
                                            <p class="mb-0">{{ update.notes }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Order Items -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Order Items
                    </h5>
                </div>
                <div class="card-body">
                    {% if order.order_items %}
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Service</th>
                                        <th>Quantity</th>
                                        <th>Weight</th>
                                        <th>Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in order.order_items %}
                                        <tr>
                                            <td>
                                                <div class="item-details">
                                                    <strong>{{ item.item_name }}</strong>
                                                    {% if item.fabric_type %}
                                                        <br><span class="badge bg-secondary">{{ item.fabric_type.title() }}</span>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="service-badge">{{ item.service.name }}</span>
                                            </td>
                                            <td>
                                                <div class="quantity-display">
                                                    <i class="fas fa-times me-1"></i>{{ item.quantity }}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="weight-display">
                                                    <i class="fas fa-weight me-1"></i>{{ "%.2f"|format(item.weight) }} kg
                                                </div>
                                            </td>
                                            <td>
                                                <strong class="text-success">₹{{ "%.2f"|format(item.price) }}</strong>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">No items added yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="col-md-4">
            <!-- Order Summary -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-receipt me-2"></i>Order Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="summary-item">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Items:</span>
                            <span class="fw-bold">{{ order.total_items }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Weight:</span>
                            <span class="fw-bold">{{ "%.2f"|format(order.total_weight) }} kg</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span class="fw-bold">₹{{ "%.2f"|format(order.subtotal) }}</span>
                        </div>
                        {% if order.discount > 0 %}
                            <div class="d-flex justify-content-between mb-2 text-success">
                                <span>Discount:</span>
                                <span class="fw-bold">-₹{{ "%.2f"|format(order.discount) }}</span>
                            </div>
                        {% endif %}
                        <hr>
                        <div class="d-flex justify-content-between fw-bold text-primary fs-5">
                            <span>Total:</span>
                            <span>₹{{ "%.2f"|format(order.total_amount) }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Addresses -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-map-marker-alt me-2"></i>Addresses
                    </h6>
                </div>
                <div class="card-body">
                    <div class="address-item mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-truck text-primary me-2"></i>
                            <h6 class="mb-0">Pickup Address</h6>
                        </div>
                        <p class="mb-1 small">{{ order.pickup_address }}</p>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>{{ order.pickup_date.strftime('%Y-%m-%d') }}
                            <i class="fas fa-clock me-1 ms-2"></i>{{ order.pickup_time }}
                        </small>
                    </div>
                    <div class="address-item">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-home text-success me-2"></i>
                            <h6 class="mb-0">Delivery Address</h6>
                        </div>
                        <p class="mb-1 small">{{ order.delivery_address }}</p>
                        {% if order.delivery_date %}
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>{{ order.delivery_date.strftime('%Y-%m-%d') }}
                                <i class="fas fa-clock me-1 ms-2"></i>{{ order.delivery_time }}
                            </small>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if order.status == 'delivered' %}
                            <a href="{{ url_for('download_invoice', order_id=order.id) }}" class="btn btn-success">
                                <i class="fas fa-download me-2"></i>Download Invoice
                            </a>
                        {% endif %}
                        
                        {% if current_user.role in ['admin', 'delivery'] and order.status not in ['delivered', 'cancelled'] %}
                            <form method="POST" action="{{ url_for('update_order_status', order_id=order.id) }}">
                                <div class="mb-3">
                                    <label class="form-label">Update Status</label>
                                    <select name="status" class="form-select" required>
                                        <option value="">Select Status</option>
                                        {% if order.status == 'pending' %}
                                            <option value="picked">Mark as Picked Up</option>
                                            <option value="cancelled">Cancel Order</option>
                                        {% elif order.status == 'picked' %}
                                            <option value="washing">Start Washing</option>
                                        {% elif order.status == 'washing' %}
                                            <option value="ready">Mark as Ready</option>
                                        {% elif order.status == 'ready' %}
                                            <option value="delivered">Mark as Delivered</option>
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notes (optional)</label>
                                    <textarea name="notes" class="form-control" rows="2" placeholder="Add any notes..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save me-2"></i>Update Status
                                </button>
                            </form>
                        {% endif %}
                        
                        {% if order.status == 'cancelled' %}
                            <div class="alert alert-danger mb-0">
                                <i class="fas fa-times-circle me-2"></i>This order has been cancelled.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating & Feedback Section -->
    {% if order.status == 'delivered' %}
        <div class="row mt-4">
            <div class="col-md-6">
                {% if order.rating is none %}
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-star me-2"></i>Rate Your Order
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('rate_order', order_id=order.id) }}">
                                <div class="mb-3">
                                    <label for="rating" class="form-label">How would you rate your order?</label>
                                    <input type="number" name="rating" class="form-control" min="0" max="5" step="0.01" required placeholder="0.0 - 5.0">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-star me-2"></i>Submit Rating
                                </button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-star me-2"></i>Your Rating
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="rating-display">
                                <div class="rating-stars mb-2">
                                    {% for i in range(5) %}
                                        <i class="fas fa-star {{ 'text-warning' if i < order.rating else 'text-muted' }}"></i>
                                    {% endfor %}
                                </div>
                                <p class="mb-0">You rated this order <strong>{{ order.rating }} / 5</strong></p>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <div class="col-md-6">
                {% if order.complaint is none %}
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Submit a Complaint
                            </h6>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('submit_complaint', order_id=order.id) }}">
                                <div class="mb-3">
                                    <label for="complaint" class="form-label">Describe your complaint:</label>
                                    <textarea name="complaint" class="form-control" rows="3" required placeholder="Tell us about your issue..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Submit Complaint
                                </button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Your Complaint
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-info-circle me-2"></i>You have submitted a complaint for this order.
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</div>

<style>
.item-details {
    line-height: 1.4;
}

.service-badge {
    background: var(--primary-gradient);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 500;
}

.quantity-display, .weight-display {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.address-item {
    padding: 1rem;
    border-radius: 12px;
    background: rgba(102, 126, 234, 0.05);
    border: 1px solid rgba(102, 126, 234, 0.1);
}

.rating-stars {
    font-size: 1.5rem;
}

.rating-display {
    text-align: center;
    padding: 1rem;
}

.summary-item {
    background: rgba(102, 126, 234, 0.05);
    border-radius: 12px;
    padding: 1rem;
}

@media (max-width: 768px) {
    .step {
        padding: 0.5rem;
    }
    
    .step-icon {
        font-size: 1.2rem;
    }
    
    .dashboard-header {
        text-align: center;
    }
    
    .dashboard-header .col-md-4 {
        margin-top: 1rem;
    }
    
    .address-item {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}
